name: Build and deploy Quarto site

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}
permissions:
  contents: write
  pages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      # Ensure Quarto picks up the correct Python for notebook execution
      QUARTO_JUPYTER_PYTHON: /usr/bin/python3
      # Note: this workflow uses the automatically provided GITHUB_TOKEN to push
      # to the `gh-pages` branch. If your repo has branch protection or special
      # policies that block the default token, create a personal access token
      # with repo:public_repo (or appropriate scopes) and store it as
      # `ACTIONS_DEPLOY_KEY` or similar, then replace `secrets.GITHUB_TOKEN` below.
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.4.549

      - name: Ensure system python pip and install jupyter for Quarto
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          /usr/bin/python3 -m pip install --upgrade pip setuptools wheel
          /usr/bin/python3 -m pip install -r requirements.txt
          /usr/bin/python3 -m pip install jupyter ipykernel pyyaml

      - name: Render Quarto site (output to docs/)
        run: |
          quarto render --output-dir docs

      - name: Debug show generated files
        run: |
          echo "Top-level files in workspace:"; ls -la
          echo "Contents of docs/:"; ls -la docs || true
          echo "Recursive listing (first 200 lines):"; ls -R docs | sed -n '1,200p' || true

      - name: Ensure docs/.nojekyll exists (prevents GitHub Pages Jekyll build)
        run: |
          mkdir -p docs
          if [ ! -f docs/.nojekyll ]; then touch docs/.nojekyll; fi

      - name: Deploy to gh-pages (publish ./docs)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
